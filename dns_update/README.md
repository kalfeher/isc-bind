# Updating DNS
The playbooks and variable file supplied here can be modified to update any domain name which supports dynamic update. 
## Where to run the playbooks
It is recommended that these playbooks be run on a server other than the primary DNS host. Ideally you will run these playbooks on a host set aside as a controller or management system.

## Preparing the domain
The following steps will allow you to send dynamic updates to your domain. These steps assume you manage your domain using the isc-bind role and that the domain is declared using `zonetype: 'dyn'`.

### Primary Name Server
1. Ensure you have a list item for your ansible host within the  `tsig_files` variable.
```yaml
tsig_files:
  - 'my_ansible_host'
```
2. Ensure you allow the tsig key to update the zone within the domain declaration.
```yaml
pri_domains:
  - { name: 'example.com', zonetype: 'dyn', update_policy: "update-policy { grant my_ansible_host zonesub ANY; };", dnssec_policy: "simple" }
```

### Your Ansible Host
Place the contents of the tsig file generated by the primary name server into the `dns_update_details` variable, which should be declared for your Ansible Host.
The playbook will attempt to use the details of a record which matches the domain name. If no entry exists which matches the domain, then the `default` entry will be used.
```yaml
  dns_update_details:
    'default': {host: 'ns1.example.net', tsig_name: 'my_ansible_host', tsig_key: "1234ABCDE!", tsig_algo: "hmac-sha256"}
    'example.biz': {host: 'ns1.example.org', tsig_name: 'my_ansible_host', tsig_key: "{{vault_my_key}}", tsig_algo: "hmac-sha256"}
```
_Warning! Anyone who can read this variable will have the ability to make DNS changes to your domains. For additional security, you should place the tsig_key into Ansible Vault_

## The dns_update Files
The `dns_update` directory contains the following files:
1. `common_dns_vars.yml`: This file should contain variables you may use for more than one domain. The variables prefixed with `soa` will be used to generate the SOA record for your domains.
2. `example-com.yml`: An example file containing the zone contents for the domain 'example.com'.
3. `run_update.yml`: This is the playbook which will run an update for a particular domain.
4. `update_tasks.yml`: This file contains tasks which may be called by `run_update.yml`.

## Updating a domain.
In order to update a domain you need to ensure that a zone contents file exists. The zone contents file name must follow these guidelines:
1. The file name should be all lowercase.
2. The file name should be the same as the domain whose contents it represents, however hyphens '-' should be used in place of periods '.'.
3. The file should use the '.yml' extension after the name
The domain name must be supplied at the time of running the update as a variable (`domainname`) at the command line. While it is possible to have the `domainname` variable defined permenently, this will only work if you have a single domain.
```bash
ansible-playbook run_update.yml -e "domainname=example.com"
```
### Choosing Which Records to Update
By supplying the relevant tag when calling the `run_update.yml` playbook, the specific tasks executed can be chosen.
*_no tag_*: When no tag is supplied, the items in the list `zone_contents` are updated within the domain
*cname*: When `cname` is supplied as a tag, then the items in the list `cname_records` are updated within the domain
*txt*: When `txt` is supplied as a tag, then iterms in the list `zone_contents` which are TXT records are updated within the domain
*template*: When `template` is supplied as a tag, the items in the list `template_records` are updated within the domain
*blocked* or *delete*: When either `blocked` or `delete` are supplied as a tag then the items in the list `blocked_records` are _deleted_ from the domain.

_Note that the task to delete records in the `blocked_records` list will always run regardless of the tag supplied. This ensures that records which should not be present are always removed from the domain. Supplying the `blocked` or `delete` tag simply ensures that no other update action occurs._

